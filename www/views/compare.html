<!DOCTYPE html>
<html lang="en">
<head>
  <title>HeatpumpMonitor.org</title>
  
  <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
<script src="https://code.jquery.com/jquery-3.6.3.min.js"></script>
  <link rel="stylesheet" href="views/style.css?v=8" />
  <link href="https://openenergymonitor.org/homepage/theme/favicon.ico" rel="shortcut icon">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css">
  <script src="https://cdn.plot.ly/plotly-2.18.1.min.js" charset="utf-8"></script>
</head>

<body>

<div id="header">
  <div id="title"><span class="big">
    <b>HeatpumpMonitor</b>.org</span></div>
  <div id="navigation">
    <a href="." title="Home"><i aria-hidden="true" class="fas fa-home"></i></a>
    <a href="stats.html" title="30 Day Stats"><i aria-hidden="true" class="fas fa-table"></i></a>
    <a href="costs.html" title="Running Costs"><i aria-hidden="true" class="fas fa-coins"></i></a>
    <a href="graph.html" title="Comparison Charts" class="active"><i aria-hidden="true" class="fas fa-chart-line"></i></a>
  </div>
  <div id="tagline">An open source initiative to share and compare heat pump performance data.</div>
</div>
  <div id="app">
  <p>Compare hourly performance data over the last 30 days</p>
    <label>Mode</label>
    <select v-model="mode" @change="change_mode">
      <option value="cop_vs_dt">COP vs Flow - Outside temperature</option>
      <option value="cop_vs_outside">COP vs Outside temperature</option>
      <option value="cop_vs_flow">COP vs Flow temperature</option>
      <option value="cop_vs_return">COP vs Return temperature</option>
      <option value="cop_vs_carnot">COP vs Carnot COP</option>
      <option value="heat_vs_outside">Heat output vs Outside temperature</option>
      <option value="elec_vs_outside">Electric input vs Outside temperature</option>
      <option value="profile">Average Profile</option>
    </select>
    
    <label>Interval</label>
    <select id="interval_select">
      <option value="3600">Hourly</option>
      <option value="86400">Daily</option>
    </select>
    
    <button @click="add_system">+ Add system</button>
    
    <br><br>
    <!--<select><option v-for="days, index in days_in_month" v-bind:value="index">{{ days }}</option></select>
    <select><option v-for="month, index in months" v-bind:value="index">{{ month }}</option></select>-->
    <table>
    <tr>
      <th>Color</th>
      <th>System</th>
      <th>Start</th>
      <th>End</th>
      <th></th>
    </tr>
    <tr v-for="system,idx in selected_systems">
      <td><input type="color" v-model="system.color" @change="change_color"></td>
      <td><select v-model="system.id" @change="change_system(idx)"><option v-for="s,i in system_list" v-bind:value="i">{{ s.location }},  {{ s.hp_model }}, {{ s.hp_output }} kW</option></select></td>
      <td><input v-model="system.start" type="date" @change="date_changed(idx)"></td>
      <td><input v-model="system.end" type="date" @change="date_changed(idx)"></td>
      <td><button v-if="system.time_changed" @click="change_dates(idx)">Load</button></td>
    </tr>
    </table>
  </div>
  
  <div id="gd" style="height:690px"></div>

<div class="footer">An <a href="https://openenergymonitor.org/">OpenEnergyMonitor.org</a> community initiative</div>
</body>
</html>


<script>

var system_list = [];
$.ajax({dataType: "json", url: "data.json", async: false, success: function(result) { system_list = result; }});

var app = new Vue({
  el: '#app',
  data: {
    mode: "cop_vs_dt",
    months: ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],
    days_in_month: [31,28,31,30,31,30,31,31,30,31,30,31],
    years: [2020,2021,2022,2023],
    selected_systems: [
      {color:"#0000ff", id:0, start: "2023-02-05", end: "2023-03-05", time_changed: false, data: false},
      {color:"#ff0000", id:1, start: "2023-02-05", end: "2023-03-05", time_changed: false, data: false}
    ],
    system_list: system_list
  },
  methods: {
    add_system: function() {
      app.selected_systems.push(JSON.parse(JSON.stringify(app.selected_systems[app.selected_systems.length-1])))
      load_system_data(app.selected_systems.length-1);
      draw_chart();
    }, 
    
    change_mode: function() {
      // load_all();
      draw_chart();    
    },
    
    change_color: function() {
      draw_chart();  
    },
    
    change_system: function(idx) {
      load_system_data(idx);
      draw_chart();
    },
    
    date_changed: function(idx) {
      app.selected_systems[idx].time_changed = true;
    },
    
    change_dates: function(idx) {
    
      date = new Date(app.selected_systems[idx].start+" 00:00:00");
      if (date.getFullYear()<2020) {
        date.setFullYear(2020);
        app.selected_systems[idx].start = time_to_date_str(date.getTime()*0.001);
      }
      if (!isNaN(date.getTime())) {
        start = date.getTime()*0.001;
      }
      
      date = new Date(app.selected_systems[idx].end+" 00:00:00");
      if (date.getFullYear()>2023) {
        date.setFullYear(2023);
        app.selected_systems[idx].end = time_to_date_str(date.getTime()*0.001);
      }
      if (!isNaN(date.getTime())) {
        end = date.getTime()*0.001;
      }  
      
      if (start>(end-(3600*24))) {
          start = end-(3600*24)
          app.selected_systems[idx].start = time_to_date_str(start);
      } 

      var npoints = Math.round((end - start)/interval);
      if (npoints>6000) interval = 3600*24;

      load_all();
      draw_chart();
      app.selected_systems[idx].time_changed = false;
    }
  }
});

interval = 3600;
$("#interval_select").val(interval);

var timeout = false;

load_all();
draw_chart();

function draw_chart() {

   var plot_data = {
      "data": [],
      "layout": {
        "font": {
          "size": 14
        },
        "title": {
          "text": ""
        },
        "xaxis": {
          "type": "linear",
          "range": [],
          "title": {
            "text": ""
          },
          "autorange": true
        },
        "yaxis": {
          "type": "linear",
          "range": [],
          "title": {
            "text": ""
          },
          "autorange": true
        },
        "autosize": true,
        "showlegend": false,
        "annotations": []
      },
      "frames": []
    }
    
    let date = new Date();
    
    for (var i in app.selected_systems) {
        let id = app.selected_systems[i].id
        let data = app.selected_systems[i].data;

        let x = [];
        let y = [];
        let size = []
        
        var time = date_str_to_time(app.selected_systems[i].start);
                
        var profile = {};
        for (var t=0; t<24; t+=(interval/3600)) {
            profile[t]=0;
        }
                
        for (var z in data['elec']) {
            let elec = data['elec'][z];
            let heat = data['heat'][z];
            let outsideT = data['outsideT'][z];
            let flowT = data['flowT'][z];
            let returnT = data['returnT'][z];
                 
            if (app.mode=="cop_vs_dt") {
                if (elec!=null && heat!=null && outsideT!=null && flowT!=null && elec>0 && heat>0) {
                    x.push(flowT - outsideT)
                    y.push(heat / elec)   
                    size.push(heat*0.002)
                }
            } else if (app.mode=="cop_vs_outside") { 
                if (elec!=null && heat!=null && outsideT!=null && elec>0 && heat>0) {  
                    x.push(outsideT)
                    y.push(heat / elec)   
                    size.push(heat*0.002)              
                }        
            } else if (app.mode=="cop_vs_flow") { 
                if (elec!=null && heat!=null && flowT!=null && elec>0 && heat>0) {
                    x.push(flowT)
                    y.push(heat / elec)   
                    size.push(heat*0.002)  
                }
            } else if (app.mode=="cop_vs_return") { 
                if (elec!=null && heat!=null && returnT!=null && elec>0 && heat>0) {
                    x.push(returnT)
                    y.push(heat / elec)   
                    size.push(heat*0.002)
                }
            } else if (app.mode=="cop_vs_carnot") { 
                if (elec!=null && heat!=null && outsideT!=null && flowT!=null && elec>0 && heat>0) {
                    let carnot = (flowT+2+273) / ((flowT+2+273) - (outsideT-6+273));
                    x.push(carnot)
                    y.push(heat / elec)   
                    size.push(heat*0.002)
                }
            } else if (app.mode=="heat_vs_outside") { 
                if (heat!=null && outsideT!=null && heat>0) {
                    x.push(outsideT)
                    y.push(heat)   
                    size.push(heat*0.002)
                }
            } else if (app.mode=="elec_vs_outside") { 
                if (elec!=null && outsideT!=null && elec>0) { 
                    x.push(outsideT)
                    y.push(elec)   
                    size.push(elec*0.002) 
                } 
            } else if (app.mode=="profile") { 
                if (elec!=null) { 
                    date.setTime(time*1000);
                    let hm = date.getHours() + (date.getMinutes()/60);
                    profile[hm] += (elec*interval)/3600000;
                }
            }
            
            time += interval;
        }
        
        if (app.mode=="profile") { 
            for (var hm=0; hm<24; hm+=(interval/3600)) {
                x.push(hm)
                y.push(profile[hm])
                size.push(10)  
            }
        }
        
        var titles = {
            "cop_vs_dt": {xaxis: "DT (Flow - Outside temperature)", yaxis: "COP"},
            "cop_vs_outside": {xaxis: "Outside temperature", yaxis: "COP"},
            "cop_vs_flow": {xaxis: "Flow temperature", yaxis: "COP"},
            "cop_vs_return": {xaxis: "Return temperature", yaxis: "COP"},
            "cop_vs_carnot": {xaxis: "Ideal Carnot COP", yaxis: "COP"},
            "heat_vs_outside": {xaxis: "Outside temperature", yaxis: "Heat"},
            "elec_vs_outside": {xaxis: "Outside temperature", yaxis: "Elec"},
            "profile": {xaxis: "Time of day", yaxis: "Elec"}
        }
        
        plot_data.layout.title.text = titles[app.mode].yaxis+" vs "+titles[app.mode].xaxis;
        plot_data.layout.xaxis.title.text = titles[app.mode].xaxis;
        plot_data.layout.yaxis.title.text = titles[app.mode].yaxis;
        
        plot_data.data.push({
          "mode": "markers",
          "type": "scatter",
          "x": x, "y": y,
          "marker": {
            "line": {
              "width": 0
            },
            "size": size,
            "color": app.selected_systems[i].color
          }
        });
    }

    Plotly.newPlot("gd",plot_data);
    console.log("redraw complete");
}

$("#interval_select").change(function(){
    var _interval = $(this).val()*1;

    var npoints = Math.round((end - start)/_interval);
    if (npoints>6000) _interval = 3600*24;
    interval = _interval;

    $("#loading").show();
    

});

function load_all() {
  for (var z in app.selected_systems) {
    load_system_data(z);
  }
}

function load_system_data(idx) {
  var system = app.selected_systems[idx];
  $.ajax({
    dataType: "json", 
    url: "api/data/all?system="+(system.id+1)+"&start="+date_str_to_time(system.start)+"&end="+date_str_to_time(system.end)+"&interval="+interval, 
    async:false, 
    success: function(system_data) {
      app.selected_systems[idx].data = system_data;
    }
  });
}

function time_to_date_str(time) {
    var date = new Date(time*1000);
    var yyyy = date.getFullYear();
    var mm = date.getMonth()+1;
    if (mm<10) mm = "0"+mm;
    var dd = date.getDate();
    if (dd<10) dd = "0"+dd;
    return yyyy+"-"+mm+"-"+dd;
}

function date_str_to_time(str) {
    return (new Date(str+" 00:00:00")).getTime()*0.001;
}
</script>
