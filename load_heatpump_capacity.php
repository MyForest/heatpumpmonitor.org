<?php
$dir = dirname(__FILE__);
chdir("$dir/www");

require "Lib/load_database.php";

require ("Modules/system/system_model.php");
$system = new System($mysqli);

/*
Capacity, Outside, 35, 40, 45, 50, 55
3.5, -5, 4.2, 41, 4, 3.9, 3.8
3.5, -3, 4.6, 4.4, 4.3, 4.2, 4
3.5, 0, 4.7, 4.7, 4.6, 4.5, 4.4
3.5, 2, 4.9, 4.9, 4.9, 47, 4.6
5, -5, 6.3, 6, 5.6, 5.5, 5.4
5, -3, 6.8, 6.4, 6.1, 5.9, 5.8
5, 0, 6.9, 6.7, 6.6, 6.4, 6.2
5, 2, 7.1, 7, 6.9, 6.7, 6.5
7, -5, 8.2, 8.1, 8, 7.5, 7
7, -3, 8.8, 8.6, 8.4, 7.9, 7.4
7, 0, 9.5, 9.3, 9.1, 8.6, 8.1
7, 2, 10, 9.8, 9.6, 9, 8.5
10, -5, 9.9, 9.7, 9.4, 9.1, 8.8
10, -3, 10.7, 10.3, 10, 9.6, 9.2
10, 0, 11.9, 11.6, 11.3, 10.7, 10.2
10, 2, 12.8, 12.5, 12.1, 11.5, 10.9
12, -5, 13.1, 12.8, 12.5, 11.7, 10.8
12, -3, 13.9, 13.4, 12.9, 12.1, 11.2
12, 0, 15.2, 14.6, 141, 13.2, 12.3
12, 2, 16, 15.5, 14.9, 13.9, 13
*/

$vaillant = array(
    "3.5" => array(
        "-5" => array("35" => 4.2, "40" => 4.1, "45" => 4, "50" => 3.9, "55" => 3.8),
        "-3" => array("35" => 4.6, "40" => 4.4, "45" => 4.3, "50" => 4.2, "55" => 4),
        "0" => array("35" => 4.7, "40" => 4.7, "45" => 4.6, "50" => 4.5, "55" => 4.4),
        "2" => array("35" => 4.9, "40" => 4.9, "45" => 4.9, "50" => 4.7, "55" => 4.6)
    ),
    "5" => array(
        "-5" => array("35" => 6.3, "40" => 6, "45" => 5.6, "50" => 5.5, "55" => 5.4),
        "-3" => array("35" => 6.8, "40" => 6.4, "45" => 6.1, "50" => 5.9, "55" => 5.8),
        "0" => array("35" => 6.9, "40" => 6.7, "45" => 6.6, "50" => 6.4, "55" => 6.2),
        "2" => array("35" => 7.1, "40" => 7, "45" => 6.9, "50" => 6.7, "55" => 6.5)
    ),
    "7" => array(
        "-5" => array("35" => 8.2, "40" => 8.1, "45" => 8, "50" => 7.5, "55" => 7),
        "-3" => array("35" => 8.8, "40" => 8.6, "45" => 8.4, "50" => 7.9, "55" => 7.4),
        "0" => array("35" => 9.5, "40" => 9.3, "45" => 9.1, "50" => 8.6, "55" => 8.1),
        "2" => array("35" => 10, "40" => 9.8, "45" => 9.6, "50" => 9, "55" => 8.5)
    ),
    "10" => array(
        "-5" => array("35" => 9.9, "40" => 9.7, "45" => 9.4, "50" => 9.1, "55" => 8.8),
        "-3" => array("35" => 10.7, "40" => 10.3, "45" => 10, "50" => 9.6, "55" => 9.2),
        "0" => array("35" => 11.9, "40" => 11.6, "45" => 11.3, "50" => 10.7, "55" => 10.2),
        "2" => array("35" => 12.8, "40" => 12.5, "45" => 12.1, "50" => 11.5, "55" => 10.9)
    ),
    "12" => array(
        "-5" => array("35" => 13.1, "40" => 12.8, "45" => 12.5, "50" => 11.7, "55" => 10.8),
        "-3" => array("35" => 13.9, "40" => 13.4, "45" => 12.9, "50" => 12.1, "55" => 11.2),
        "0" => array("35" => 15.2, "40" => 14.6, "45" => 14.1, "50" => 13.2, "55" => 12.3),
        "2" => array("35" => 16, "40" => 15.5, "45" => 14.9, "50" => 13.9, "55" => 13)
    )
);

$data = $system->list_admin();
foreach ($data as $row) {
    $systemid = $row->id;

    if (trim($row->hp_model) == "Vaillant Arotherm+") {

        $flow_temp = $row->flow_temp;

        if ($flow_temp == 0) $flow_temp = 45;
        if ($flow_temp > 55) $flow_temp = 55;
        if ($flow_temp < 35) $flow_temp = 35;

        $flow_temp_A = floor($flow_temp/5)*5;
        $flow_temp_B = ceil($flow_temp/5)*5;

        $row->hp_output = trim($row->hp_output);

        $capacity_A = $vaillant[$row->hp_output]["-3"][$flow_temp_A];
        $capacity_B = $vaillant[$row->hp_output]["-3"][$flow_temp_B];
        // interpolate
        $capacity = $capacity_A + ($capacity_B - $capacity_A) * ($flow_temp - $flow_temp_A) / 5;
        // round to 1 decimal
        $capacity = round($capacity, 1);

        print $systemid." ".$row->hp_model." ".$row->hp_output." ".$row->flow_temp." ".$capacity." \n";

        // update the hp_max_output field 
        if ($capacity > 0) {
            $mysqli->query("UPDATE system_meta SET hp_max_output = $capacity WHERE id = $systemid");
        }


    }
    
}
